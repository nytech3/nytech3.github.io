<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nytech3.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="工作流程 提取所有命令参数，并做校验 检查key是否存在于client选择的db中，如果不存在并且不带XX参数则创建一个新的zobj对象加入db-&gt;dict中, 如果存在则检查是否进行编码转化（LISTPACK转化成SKIPLIST） 遍历命令中所有key，将其加入zobj对象中 a. 如果zobj的编码类型为LISTPACK，先找到对应的key是否存在于listpack中   i.如果存">
<meta property="og:type" content="article">
<meta property="og:title" content="源码阅读(七)-Redis中的ZADD命令">
<meta property="og:url" content="https://nytech3.github.io/2023/09/24/redis/redis_zadd/index.html">
<meta property="og:site_name" content="nytech">
<meta property="og:description" content="工作流程 提取所有命令参数，并做校验 检查key是否存在于client选择的db中，如果不存在并且不带XX参数则创建一个新的zobj对象加入db-&gt;dict中, 如果存在则检查是否进行编码转化（LISTPACK转化成SKIPLIST） 遍历命令中所有key，将其加入zobj对象中 a. 如果zobj的编码类型为LISTPACK，先找到对应的key是否存在于listpack中   i.如果存">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-09-24T10:00:00.000Z">
<meta property="article:modified_time" content="2024-09-19T07:25:57.001Z">
<meta property="article:author" content="nytech">
<meta property="article:tag" content="c">
<meta property="article:tag" content="redis">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://nytech3.github.io/2023/09/24/redis/redis_zadd/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>源码阅读(七)-Redis中的ZADD命令 | nytech</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">nytech</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">24</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">3</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">140</span></a>

  </li>
        <li class="menu-item menu-item-following">

    <a href="/following/" rel="section"><i class="following fa-fw"></i>关注</a>

  </li>
        <li class="menu-item menu-item-tool">

    <a href="/tool/" rel="section"><i class="tool fa-fw"></i>工具</a>

  </li>
        <li class="menu-item menu-item-dailyguide">

    <a href="/dailyguide" rel="section"><i class="dailyguide fa-fw"></i>每日导读</a>

  </li>
        <li class="menu-item menu-item-book">

    <a href="/book" rel="section"><i class="book fa-fw"></i>书籍</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/nytech3" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nytech3.github.io/2023/09/24/redis/redis_zadd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/author.jpg">
      <meta itemprop="name" content="nytech">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="nytech">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          源码阅读(七)-Redis中的ZADD命令
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-09-24 18:00:00" itemprop="dateCreated datePublished" datetime="2023-09-24T18:00:00+08:00">2023-09-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/technology/" itemprop="url" rel="index"><span itemprop="name">technology</span></a>
                </span>
            </span>

          
            <span id="/2023/09/24/redis/redis_zadd/" class="post-meta-item leancloud_visitors" data-flag-title="源码阅读(七)-Redis中的ZADD命令" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <!-- ttoc -->
<h1 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h1><ol>
<li>提取所有命令参数，并做校验</li>
<li>检查key是否存在于client选择的db中，如果不存在并且不带XX参数则创建一个新的zobj对象加入db-&gt;dict中, 如果存在则检查是否进行编码转化（LISTPACK转化成SKIPLIST）</li>
<li>遍历命令中所有key，将其加入zobj对象中<br> a. 如果zobj的编码类型为LISTPACK，先找到对应的key是否存在于listpack中<pre><code>   i.如果存在，检查是否有incr选项，如果有将命令的分值加上现有的分值，得到新的分值没有incr选项的话，命令的分值就是新的分值，如果新的分值与原有的分
     值不等的话就删除掉原有的元素和分值，再将元素和新的分值找到第一个比他大的分值和元素的位置进行插入（这里会先比较score再比较ele），
     如果新的分值与原有的分值相等的话直接返回不做任何操作，直接返回
   ii.如果不存在，检查是否有XX选项，有的话直接返回，没有的话，判断listpack是否超过服务设定的大小阈值，超过的话进行编码转化(转化成skiplist)和扩容。
     如果不超过阈值，则直接将分值和元素加入队列中。
</code></pre>
 b. 如果zobj的编码为OBJ_ENCODING_SKIPLIST，在zset-&gt;dict中查找对应的元素<pre><code>   i.如果存在，检查是否包含NX选项，包含的话直接返回，不包含的话，检查是否有incr选项，如果有将命令的分值加上现有的分值，得到新的分值没有incr选项的话，
     命令的分值就是新的分值，判断LT、GT选项是否合规，如果新旧分值不同就更新分值（会更新跳表,删除旧节点，新增新节点，详见zslUpdateScore）
   ii.如果不存在，检查是否包含XX选项，包含的话直接返回，不包含的话，将新的分值以及元素加入跳表中（详见zslInsert），并将元素加入zs-&gt;dict。
</code></pre>
</li>
<li>进行新增、更新、处理的元素数统计</li>
<li>更新<code>server.dirty</code>发生变更的元素数</li>
</ol>
<span id="more"></span>
<h1 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h1><h2 id="ZADD-json"><a href="#ZADD-json" class="headerlink" title="ZADD json"></a>ZADD json</h2><p>添加一个或者多个数据到有序集合中，否则更新他们的分值，如果对应的键不存在，则新建一个entry加入client-&gt;db-&gt;dict中，<br>其时间复杂度为logn，n为进入队列的个数，该命令在1.2.0版本后加入，对应的执行函数为<code>zaddCommand</code>,在2.4.0版本后支持添加多个元素，<br>3.0.2版本之后，新增<code>XX</code>、<code>NX</code>、<code>CH</code>、<code>INCR</code>参数，6.2.0版本之后新增了<code>GT</code>、<code>LT</code>选项</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;ZADD&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;summary&quot;</span>: <span class="string">&quot;Adds one or more members to a sorted set, or updates their scores. Creates the key if it doesn&#x27;t exist.&quot;</span>,</span><br><span class="line">        <span class="string">&quot;complexity&quot;</span>: <span class="string">&quot;O(log(N)) for each item added, where N is the number of elements in the sorted set.&quot;</span>,</span><br><span class="line">        <span class="string">&quot;group&quot;</span>: <span class="string">&quot;sorted_set&quot;</span>,</span><br><span class="line">        <span class="string">&quot;since&quot;</span>: <span class="string">&quot;1.2.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;arity&quot;</span>: <span class="number">-4</span>,</span><br><span class="line">        <span class="string">&quot;function&quot;</span>: <span class="string">&quot;zaddCommand&quot;</span>,</span><br><span class="line">        <span class="string">&quot;history&quot;</span>: [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&quot;2.4.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Accepts multiple elements.&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&quot;3.0.2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Added the `XX`, `NX`, `CH` and `INCR` options.&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&quot;6.2.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Added the `GT` and `LT` options.&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;command_flags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;WRITE&quot;</span>,</span><br><span class="line">            <span class="string">&quot;DENYOOM&quot;</span>,</span><br><span class="line">            <span class="string">&quot;FAST&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;acl_categories&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;SORTEDSET&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;key_specs&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;flags&quot;</span>: [</span><br><span class="line">                    <span class="string">&quot;RW&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;UPDATE&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;begin_search&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;pos&quot;</span>: <span class="number">1</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;find_keys&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;lastkey&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">&quot;step&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                        <span class="string">&quot;limit&quot;</span>: <span class="number">0</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;reply_schema&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;anyOf&quot;</span>:[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Operation was aborted (conflict with one of the `XX`/`NX`/`LT`/`GT` options).&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The number of new members (when the `CH` option is not used)&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The number of new or updated members (when the `CH` option is used)&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The updated score of the member (when the `INCR` option is used)&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;arguments&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">                <span class="string">&quot;key_spec_index&quot;</span>: <span class="number">0</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;condition&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;oneof&quot;</span>,</span><br><span class="line">                <span class="string">&quot;optional&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;since&quot;</span>: <span class="string">&quot;3.0.2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arguments&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;nx&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pure-token&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;token&quot;</span>: <span class="string">&quot;NX&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;xx&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pure-token&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;token&quot;</span>: <span class="string">&quot;XX&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;comparison&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;oneof&quot;</span>,</span><br><span class="line">                <span class="string">&quot;optional&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;since&quot;</span>: <span class="string">&quot;6.2.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;arguments&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;gt&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pure-token&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;token&quot;</span>: <span class="string">&quot;GT&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;lt&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pure-token&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;token&quot;</span>: <span class="string">&quot;LT&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;change&quot;</span>,</span><br><span class="line">                <span class="string">&quot;token&quot;</span>: <span class="string">&quot;CH&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pure-token&quot;</span>,</span><br><span class="line">                <span class="string">&quot;optional&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;since&quot;</span>: <span class="string">&quot;3.0.2&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;increment&quot;</span>,</span><br><span class="line">                <span class="string">&quot;token&quot;</span>: <span class="string">&quot;INCR&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pure-token&quot;</span>,</span><br><span class="line">                <span class="string">&quot;optional&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;since&quot;</span>: <span class="string">&quot;3.0.2&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;data&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;block&quot;</span>,</span><br><span class="line">                <span class="string">&quot;multiple&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">&quot;arguments&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;score&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;member&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="命令执行样例"><a href="#命令执行样例" class="headerlink" title="命令执行样例"></a>命令执行样例</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students <span class="number">1</span> <span class="string">&quot;Peter&quot;</span> <span class="number">2</span> <span class="string">&quot;Paul&quot;</span> <span class="number">3</span> <span class="string">&quot;Mary&quot;</span></span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students <span class="number">1</span> <span class="string">&quot;Peter&quot;</span> <span class="number">2</span> <span class="string">&quot;Paul&quot;</span> <span class="number">3</span> <span class="string">&quot;Mary&quot;</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students XX <span class="number">1</span> <span class="string">&quot;Peter&quot;</span> <span class="number">2</span> <span class="string">&quot;Paul&quot;</span> <span class="number">3</span> <span class="string">&quot;Mary&quot;</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students XX <span class="number">1</span> <span class="string">&quot;Peter&quot;</span> <span class="number">2</span> <span class="string">&quot;Paul&quot;</span> <span class="number">4</span> <span class="string">&quot;Mary&quot;</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students XX <span class="number">1</span> <span class="string">&quot;Peter&quot;</span> <span class="number">7</span> <span class="string">&quot;Paul&quot;</span> <span class="number">4</span> <span class="string">&quot;Mary&quot;</span></span><br><span class="line">(integer) <span class="number">0</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zmpop <span class="number">1</span> Students MAX</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;Students&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;Paul&quot;</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">&quot;7&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zmpop <span class="number">1</span> Students MAX</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;Students&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;Mary&quot;</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">&quot;4&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zmpop <span class="number">1</span> Students MAX</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;Students&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="number">1</span>) <span class="number">1</span>) <span class="string">&quot;Peter&quot;</span></span><br><span class="line">      <span class="number">2</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zmpop <span class="number">1</span> Students MAX</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students INCR <span class="number">2</span> <span class="string">&quot;zy&quot;</span>  </span><br><span class="line"><span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZADD Students CH GT <span class="number">100</span> zy</span><br><span class="line">(integer) <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><p>-&gt; zaddCommand -&gt; zaddGenericCommand :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * Sorted set commands</span></span><br><span class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* This generic command implements both ZADD and ZINCRBY. */</span></span><br><span class="line"><span class="comment">/* 这个命令实现了ZADD和ZINCRBY两个命令 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zaddGenericCommand</span><span class="params">(client *c, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> *nanerr = <span class="string">&quot;resulting score is not a number (NaN)&quot;</span>;</span><br><span class="line">    <span class="comment">// 获取命令对应的key参数</span></span><br><span class="line">    robj *key = c-&gt;argv[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">// 用于存储查找到的有序集合对象</span></span><br><span class="line">    robj *zobj;</span><br><span class="line">    <span class="comment">// 用于存储元素</span></span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="comment">// 分数</span></span><br><span class="line">    <span class="keyword">double</span> score = <span class="number">0</span>, *scores = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> j, elements, ch = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> scoreidx = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* The following vars are used in order to track what the command actually</span></span><br><span class="line"><span class="comment">     * did during the execution, to reply to the client and to trigger the</span></span><br><span class="line"><span class="comment">     * notification of keyspace change. */</span></span><br><span class="line">    <span class="comment">// 新增、更新和处理的元素数量</span></span><br><span class="line">    <span class="keyword">int</span> added = <span class="number">0</span>;      <span class="comment">/* Number of new elements added. */</span></span><br><span class="line">    <span class="keyword">int</span> updated = <span class="number">0</span>;    <span class="comment">/* Number of elements with updated score. */</span></span><br><span class="line">    <span class="keyword">int</span> processed = <span class="number">0</span>;  <span class="comment">/* Number of elements processed, may remain zero with</span></span><br><span class="line"><span class="comment">                           options like XX. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse options. At the end &#x27;scoreidx&#x27; is set to the argument position</span></span><br><span class="line"><span class="comment">     * of the score of the first score-element pair. */</span></span><br><span class="line">    <span class="comment">/* 解析命令选项，并设置scoreidx变量为第一个score-element对的位置 */</span></span><br><span class="line">    scoreidx = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span>(scoreidx &lt; c-&gt;argc) &#123;</span><br><span class="line">        <span class="keyword">char</span> *opt = c-&gt;argv[scoreidx]-&gt;ptr;</span><br><span class="line">        <span class="comment">// 判断选项类型</span></span><br><span class="line">        <span class="comment">// 只有在元素不存在时，ZADD才会成功</span></span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(opt,<span class="string">&quot;nx&quot;</span>)) flags |= ZADD_IN_NX;</span><br><span class="line">        <span class="comment">// 只有在元素存在时，ZADD才会成功</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(opt,<span class="string">&quot;xx&quot;</span>)) flags |= ZADD_IN_XX;</span><br><span class="line">        <span class="comment">// 返回添加或更新的元素数量</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(opt,<span class="string">&quot;ch&quot;</span>)) ch = <span class="number">1</span>; <span class="comment">/* Return num of elements added or updated. */</span></span><br><span class="line">        <span class="comment">// 增加元素的分数</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(opt,<span class="string">&quot;incr&quot;</span>)) flags |= ZADD_IN_INCR;</span><br><span class="line">        <span class="comment">// 添加的元素分数必须更大</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(opt,<span class="string">&quot;gt&quot;</span>)) flags |= ZADD_IN_GT;</span><br><span class="line">        <span class="comment">// 添加的元素分数必须更小</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(opt,<span class="string">&quot;lt&quot;</span>)) flags |= ZADD_IN_LT;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">break</span>;</span><br><span class="line">        scoreidx++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Turn options into simple to check vars. */</span></span><br><span class="line">    <span class="comment">/* 将选项转换成易于检查的变量 */</span></span><br><span class="line">    <span class="keyword">int</span> incr = (flags &amp; ZADD_IN_INCR) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> nx = (flags &amp; ZADD_IN_NX) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> xx = (flags &amp; ZADD_IN_XX) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> gt = (flags &amp; ZADD_IN_GT) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> lt = (flags &amp; ZADD_IN_LT) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* After the options, we expect to have an even number of args, since</span></span><br><span class="line"><span class="comment">     * we expect any number of score-element pairs. */</span></span><br><span class="line">    <span class="comment">/* 检查参数数量是否为偶数 */</span></span><br><span class="line">    elements = c-&gt;argc-scoreidx;</span><br><span class="line">    <span class="keyword">if</span> (elements % <span class="number">2</span> || !elements) &#123;</span><br><span class="line">        addReplyErrorObject(c,shared.syntaxerr);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 保存score-element对的数量 */</span></span><br><span class="line">    elements /= <span class="number">2</span>; <span class="comment">/* Now this holds the number of score-element pairs. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check for incompatible options. */</span></span><br><span class="line">    <span class="comment">/* 检查是否有不兼容的选项 */</span></span><br><span class="line">    <span class="keyword">if</span> (nx &amp;&amp; xx) &#123;</span><br><span class="line">        addReplyError(c,</span><br><span class="line">            <span class="string">&quot;XX and NX options at the same time are not compatible&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((gt &amp;&amp; nx) || (lt &amp;&amp; nx) || (gt &amp;&amp; lt)) &#123;</span><br><span class="line">        addReplyError(c,</span><br><span class="line">            <span class="string">&quot;GT, LT, and/or NX options at the same time are not compatible&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Note that XX is compatible with either GT or LT */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (incr &amp;&amp; elements &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        addReplyError(c,</span><br><span class="line">            <span class="string">&quot;INCR option supports a single increment-element pair&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Start parsing all the scores, we need to emit any syntax error</span></span><br><span class="line"><span class="comment">     * before executing additions to the sorted set, as the command should</span></span><br><span class="line"><span class="comment">     * either execute fully or nothing at all. */</span></span><br><span class="line">    <span class="comment">/* 解析所有分数，发现任何语法错误都需要在执行添加操作之前返回，因为命令应该要么全部执行，要么全部不执行 */</span></span><br><span class="line">    scores = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">double</span>)*elements);</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; elements; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getDoubleFromObjectOrReply(c,c-&gt;argv[scoreidx+j*<span class="number">2</span>],&amp;scores[j],<span class="literal">NULL</span>)</span><br><span class="line">            != C_OK) <span class="keyword">goto</span> cleanup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Lookup the key and create the sorted set if does not exist. */</span></span><br><span class="line">    <span class="comment">/* 查找key对应的值 */</span></span><br><span class="line">    zobj = lookupKeyWrite(c-&gt;db,key);</span><br><span class="line">    <span class="comment">// checkType检查对象是否为ZSET对象，如果不为ZSET对象则返回0</span></span><br><span class="line">    <span class="keyword">if</span> (checkType(c,zobj,OBJ_ZSET)) <span class="keyword">goto</span> cleanup;</span><br><span class="line">    <span class="comment">// 如果key对应的值为NULL</span></span><br><span class="line">    <span class="keyword">if</span> (zobj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果有XX参数（key存在才更新）的话，直接返回客户端</span></span><br><span class="line">        <span class="keyword">if</span> (xx) <span class="keyword">goto</span> reply_to_client; <span class="comment">/* No key + XX option: nothing to do. */</span></span><br><span class="line">        <span class="comment">// 创建一个zset对象</span></span><br><span class="line">        zobj = zsetTypeCreate(elements, sdslen(c-&gt;argv[scoreidx+<span class="number">1</span>]-&gt;ptr));</span><br><span class="line">        <span class="comment">// 将zset对象加入db中</span></span><br><span class="line">        dbAdd(c-&gt;db,key,zobj);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果key对应的zset对象存在则检查是否需要进行编码转化（从LISTPACK转化成SKIPLIST），需要转化则进行转化</span></span><br><span class="line">        zsetTypeMaybeConvert(zobj, elements);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历新增的elements</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; elements; j++) &#123;</span><br><span class="line">        <span class="keyword">double</span> newscore;</span><br><span class="line">        score = scores[j];</span><br><span class="line">        <span class="keyword">int</span> retflags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        ele = c-&gt;argv[scoreidx+<span class="number">1</span>+j*<span class="number">2</span>]-&gt;ptr;</span><br><span class="line">        <span class="keyword">int</span> retval = zsetAdd(zobj, score, ele, flags, &amp;retflags, &amp;newscore);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            addReplyError(c,nanerr);</span><br><span class="line">            <span class="keyword">goto</span> cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 新增数据计数+1</span></span><br><span class="line">        <span class="keyword">if</span> (retflags &amp; ZADD_OUT_ADDED) added++;</span><br><span class="line">        <span class="comment">// 更新数据计数+1</span></span><br><span class="line">        <span class="keyword">if</span> (retflags &amp; ZADD_OUT_UPDATED) updated++;</span><br><span class="line">        <span class="comment">// 如果没有ZADD_OUT_NOP标识证明又被处理，即有更新或者新增</span></span><br><span class="line">        <span class="keyword">if</span> (!(retflags &amp; ZADD_OUT_NOP)) processed++;</span><br><span class="line">        score = newscore;</span><br><span class="line">    &#125;</span><br><span class="line">    server.dirty += (added+updated);</span><br><span class="line"></span><br><span class="line">reply_to_client:</span><br><span class="line">    <span class="comment">// 当包含INCR参数时</span></span><br><span class="line">    <span class="keyword">if</span> (incr) &#123; <span class="comment">/* ZINCRBY or INCR option. */</span></span><br><span class="line">        <span class="comment">// 有数据发生变更</span></span><br><span class="line">        <span class="keyword">if</span> (processed)</span><br><span class="line">            <span class="comment">// 返回新的分值</span></span><br><span class="line">            addReplyDouble(c,score);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// 否则返回null</span></span><br><span class="line">            addReplyNull(c);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/* ZADD. */</span></span><br><span class="line">        <span class="comment">// 如果选项包含了CH，则返回变更的数据</span></span><br><span class="line">        addReplyLongLong(c,ch ? added+updated : added);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">cleanup:</span><br><span class="line">    <span class="comment">// 释放scores空间</span></span><br><span class="line">    zfree(scores);</span><br><span class="line">    <span class="comment">// 如果发生了add或者update</span></span><br><span class="line">    <span class="keyword">if</span> (added || updated) &#123;</span><br><span class="line">        <span class="comment">// 是送变更信号</span></span><br><span class="line">        signalModifiedKey(c,c-&gt;db,key);</span><br><span class="line">        <span class="comment">// zset通知</span></span><br><span class="line">        notifyKeyspaceEvent(NOTIFY_ZSET,</span><br><span class="line">            incr ? <span class="string">&quot;zincr&quot;</span> : <span class="string">&quot;zadd&quot;</span>, key, c-&gt;db-&gt;id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetTypeCreate:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Factory method to return a zset.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The size hint indicates approximately how many items will be added,</span></span><br><span class="line"><span class="comment"> * and the value len hint indicates the approximate individual size of the added elements,</span></span><br><span class="line"><span class="comment"> * they are used to determine the initial representation.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the hints are not known, and underestimation or 0 is suitable. */</span></span><br><span class="line"><span class="function">robj *<span class="title">zsetTypeCreate</span><span class="params">(<span class="keyword">size_t</span> size_hint, <span class="keyword">size_t</span> val_len_hint)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 如果预计的元素数量和每个元素的大小都不超过服务器设定的最大值，</span></span><br><span class="line"><span class="comment">    * 那么创建一个使用Listpack作为底层实现的有序集合对象 */</span></span><br><span class="line">    <span class="keyword">if</span> (size_hint &lt;= server.zset_max_listpack_entries &amp;&amp;</span><br><span class="line">        val_len_hint &lt;= server.zset_max_listpack_value)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> createZsetListpackObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 否则，创建一个使用ziplist作为底层实现的有序集合对象 */</span></span><br><span class="line">    robj *zobj = createZsetObject();</span><br><span class="line">    zset *zs = zobj-&gt;ptr;</span><br><span class="line">    <span class="comment">/* 扩大字典的大小以容纳预计要添加的元素数量 */</span></span><br><span class="line">    dictExpand(zs-&gt;dict, size_hint);</span><br><span class="line">    <span class="keyword">return</span> zobj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetTypeMaybeConvert:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if the existing zset should be converted to another encoding based off the</span></span><br><span class="line"><span class="comment"> * the size hint. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zsetTypeMaybeConvert</span><span class="params">(robj *zobj, <span class="keyword">size_t</span> size_hint)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断编码类型是否为OBJ_ENCODING_LISTPACK，是的话判断大小是否大于服务设置的zset_max_listpack_entries，大于的话则进行类型转化</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_LISTPACK &amp;&amp;</span><br><span class="line">        size_hint &gt; server.zset_max_listpack_entries)</span><br><span class="line">    &#123;</span><br><span class="line">        zsetConvertAndExpand(zobj, OBJ_ENCODING_SKIPLIST, size_hint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetTypeMaybeConvert -&gt; zsetConvertAndExpand:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Converts a zset to the specified encoding, pre-sizing it for &#x27;cap&#x27; elements. */</span></span><br><span class="line"><span class="comment">// zset的编码类型转化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zsetConvertAndExpand</span><span class="params">(robj *zobj, <span class="keyword">int</span> encoding, <span class="keyword">unsigned</span> <span class="keyword">long</span> cap)</span> </span>&#123;</span><br><span class="line">    zset *zs;</span><br><span class="line">    zskiplistNode *node, *next;</span><br><span class="line">    sds ele;</span><br><span class="line">    <span class="keyword">double</span> score;</span><br><span class="line">    <span class="comment">// 如果当前编码就是目标编码就直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == encoding) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 如果当前编码为LISTPACK</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_LISTPACK) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl = zobj-&gt;ptr;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr, *sptr;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *vstr;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> vlen;</span><br><span class="line">        <span class="keyword">long</span> <span class="keyword">long</span> vlong;</span><br><span class="line">        <span class="comment">// 确保目标编码是SKIPLIST</span></span><br><span class="line">        <span class="keyword">if</span> (encoding != OBJ_ENCODING_SKIPLIST)</span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown target encoding&quot;</span>);</span><br><span class="line">        <span class="comment">// 为新的ZSET对象zs分配内存</span></span><br><span class="line">        zs = zmalloc(<span class="keyword">sizeof</span>(*zs));</span><br><span class="line">        <span class="comment">// 创建一个zsetDictType类型的字典</span></span><br><span class="line">        <span class="comment">/* Sorted sets hash (note: a skiplist is used in addition to the hash table) */</span></span><br><span class="line">        <span class="comment">//    dictType zsetDictType = &#123;</span></span><br><span class="line">        <span class="comment">//          dictSdsHash,               /* hash function */</span></span><br><span class="line">        <span class="comment">//          NULL,                      /* key dup */</span></span><br><span class="line">        <span class="comment">//          NULL,                      /* val dup */</span></span><br><span class="line">        <span class="comment">//          dictSdsKeyCompare,         /* key compare */</span></span><br><span class="line">        <span class="comment">//          NULL,                      /* Note: SDS string shared &amp; freed by skiplist */</span></span><br><span class="line">        <span class="comment">//          NULL,                      /* val destructor */</span></span><br><span class="line">        <span class="comment">//          NULL                       /* allow to expand */</span></span><br><span class="line">        <span class="comment">//    &#125;;</span></span><br><span class="line">        zs-&gt;dict = dictCreate(&amp;zsetDictType);</span><br><span class="line">        <span class="comment">// 创建跳跃表对象</span></span><br><span class="line">        <span class="comment">/* Create a new skiplist. */</span></span><br><span class="line">        <span class="comment">//   zskiplist *zslCreate(void) &#123;</span></span><br><span class="line">        <span class="comment">//      int j;</span></span><br><span class="line">        <span class="comment">//      zskiplist *zsl;    跳跃表</span></span><br><span class="line">        <span class="comment">//      zsl = zmalloc(sizeof(*zsl));   为跳跃表分配内存</span></span><br><span class="line">        <span class="comment">//      zsl-&gt;level = 1;    初始化跳跃表的level（层级）为1层</span></span><br><span class="line">        <span class="comment">//      zsl-&gt;length = 0;   初始化长度为0</span></span><br><span class="line">        <span class="comment">//      zsl-&gt;header = zslCreateNode(ZSKIPLIST_MAXLEVEL,0,NULL);   创建一个新的跳表节点作为头节点，其最大层级为ZSKIPLIST_MAXLEVEL，分数为0，元素为NULL</span></span><br><span class="line">        <span class="comment">//      for (j = 0; j &lt; ZSKIPLIST_MAXLEVEL; j++) &#123; 遍历header的每一层level，为其进行初始化</span></span><br><span class="line">        <span class="comment">//          zsl-&gt;header-&gt;level[j].forward = NULL;    设置前进节点为NULL</span></span><br><span class="line">        <span class="comment">//          zsl-&gt;header-&gt;level[j].span = 0;    设置与下一个节点中间跨越的节点为0个</span></span><br><span class="line">        <span class="comment">//      &#125;</span></span><br><span class="line">        <span class="comment">//      zsl-&gt;header-&gt;backward = NULL;    设置后退节点为NULL</span></span><br><span class="line">        <span class="comment">//      zsl-&gt;tail = NULL;      设置尾部节点为空</span></span><br><span class="line">        <span class="comment">//      return zsl; </span></span><br><span class="line">        <span class="comment">//   &#125;</span></span><br><span class="line">        zs-&gt;zsl = zslCreate();</span><br><span class="line">        <span class="comment">// 对zs的dict进行扩容</span></span><br><span class="line">        <span class="comment">/* Presize the dict to avoid rehashing */</span></span><br><span class="line">        dictExpand(zs-&gt;dict, cap);</span><br><span class="line">        <span class="comment">// 获取lp中第0个数据的指针</span></span><br><span class="line">        eptr = lpSeek(zl,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (eptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取下一个数据的指针</span></span><br><span class="line">            sptr = lpNext(zl,eptr);</span><br><span class="line">            <span class="comment">// 确保sptr不为空</span></span><br><span class="line">            serverAssertWithInfo(<span class="literal">NULL</span>,zobj,sptr != <span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历列表，将其转换为跳表</span></span><br><span class="line">        <span class="keyword">while</span> (eptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取sptr位置的数值（score）</span></span><br><span class="line">            score = zzlGetScore(sptr);</span><br><span class="line">            <span class="comment">// 获取元素值</span></span><br><span class="line">            vstr = lpGetValue(eptr,&amp;vlen,&amp;vlong);</span><br><span class="line">            <span class="keyword">if</span> (vstr == <span class="literal">NULL</span>)</span><br><span class="line">                ele = sdsfromlonglong(vlong);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                ele = sdsnewlen((<span class="keyword">char</span>*)vstr,vlen);</span><br><span class="line">            <span class="comment">// 插入到跳表中，并在字典中添加相应的元素</span></span><br><span class="line">            node = zslInsert(zs-&gt;zsl,score,ele);</span><br><span class="line">            <span class="comment">// 将元素加入dict中</span></span><br><span class="line">            serverAssert(dictAdd(zs-&gt;dict,ele,&amp;node-&gt;score) == DICT_OK);</span><br><span class="line">            <span class="comment">// 获取下一个ele和score</span></span><br><span class="line">            zzlNext(zl,&amp;eptr,&amp;sptr);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 释放zobj-&gt;ptr(listpack对象)的内存</span></span><br><span class="line">        zfree(zobj-&gt;ptr);</span><br><span class="line">        <span class="comment">// 将ptr指向新的zset对象</span></span><br><span class="line">        zobj-&gt;ptr = zs;</span><br><span class="line">        <span class="comment">// 将编码类型设置成OBJ_ENCODING_SKIPLIST</span></span><br><span class="line">        zobj-&gt;encoding = OBJ_ENCODING_SKIPLIST;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123;</span><br><span class="line">        <span class="comment">// 初始化一个listpack对象</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl = lpNew(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 如果目标类型不是listpack则报错</span></span><br><span class="line">        <span class="keyword">if</span> (encoding != OBJ_ENCODING_LISTPACK)</span><br><span class="line">            serverPanic(<span class="string">&quot;Unknown target encoding&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Approach similar to zslFree(), since we want to free the skiplist at</span></span><br><span class="line"><span class="comment">         * the same time as creating the listpack. */</span></span><br><span class="line">        <span class="comment">// 获取zobj的数据指针</span></span><br><span class="line">        zs = zobj-&gt;ptr;</span><br><span class="line">        <span class="comment">// 释放zs中的dict对象(用于存储ele)</span></span><br><span class="line">        dictRelease(zs-&gt;dict);</span><br><span class="line">        <span class="comment">// 获取跳表中的第一个node</span></span><br><span class="line">        node = zs-&gt;zsl-&gt;header-&gt;level[<span class="number">0</span>].forward;</span><br><span class="line">        <span class="comment">// 释放跳表中的header</span></span><br><span class="line">        zfree(zs-&gt;zsl-&gt;header);</span><br><span class="line">        <span class="comment">// 释放跳表中的数据</span></span><br><span class="line">        zfree(zs-&gt;zsl);</span><br><span class="line">        <span class="comment">// 当node数据存在时</span></span><br><span class="line">        <span class="keyword">while</span> (node) &#123;</span><br><span class="line">            <span class="comment">// 将数据插入zl中</span></span><br><span class="line">            zl = zzlInsertAt(zl,<span class="literal">NULL</span>,node-&gt;ele,node-&gt;score);</span><br><span class="line">            <span class="comment">// 获取下一个node节点</span></span><br><span class="line">            next = node-&gt;level[<span class="number">0</span>].forward;</span><br><span class="line">            <span class="comment">//释放当前的node节点</span></span><br><span class="line">            zslFreeNode(node);</span><br><span class="line">            <span class="comment">// 将node设置成下一个node</span></span><br><span class="line">            node = next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 释放zs的内存空间</span></span><br><span class="line">        zfree(zs);</span><br><span class="line">        <span class="comment">// 将zobj对象的数据指针指向zl</span></span><br><span class="line">        zobj-&gt;ptr = zl;</span><br><span class="line">        <span class="comment">// 将编码类型转成OBJ_ENCODING_LISTPACK</span></span><br><span class="line">        zobj-&gt;encoding = OBJ_ENCODING_LISTPACK;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverPanic(<span class="string">&quot;Unknown sorted set encoding&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetTypeMaybeConvert -&gt; zsetConvertAndExpand -&gt; zslCreate -&gt; zslCreateNode:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create a skiplist node with the specified number of levels.</span></span><br><span class="line"><span class="comment"> * The SDS string &#x27;ele&#x27; is referenced by the node after the call. */</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslCreateNode</span><span class="params">(<span class="keyword">int</span> level, <span class="keyword">double</span> score, sds ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 为znode分配内存空间</span></span><br><span class="line">    zskiplistNode *zn =</span><br><span class="line">        zmalloc(<span class="keyword">sizeof</span>(*zn)+level*<span class="keyword">sizeof</span>(struct zskiplistLevel));</span><br><span class="line">    <span class="comment">// 设置zn的分数</span></span><br><span class="line">    zn-&gt;score = score;</span><br><span class="line">    <span class="comment">// 设置zn的元素</span></span><br><span class="line">    zn-&gt;ele = ele;</span><br><span class="line">    <span class="keyword">return</span> zn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetTypeMaybeConvert -&gt; zsetConvertAndExpand -&gt; zslInsert:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Insert a new node in the skiplist. Assumes the element does not already</span></span><br><span class="line"><span class="comment"> * exist (up to the caller to enforce that). The skiplist takes ownership</span></span><br><span class="line"><span class="comment"> * of the passed SDS string &#x27;ele&#x27;. */</span></span><br><span class="line"><span class="comment">// 跳跃表的数据插入</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, sds ele)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化一个用于更新的节点数组和一个临时节点指针</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="comment">// 初始化一个用于存储各层插入位置之前的节点数量的数组</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rank[ZSKIPLIST_MAXLEVEL];</span><br><span class="line">    <span class="comment">// 初始化一个用于记录新节点的层数的变量和一个循环变量。</span></span><br><span class="line">    <span class="keyword">int</span> i, level;</span><br><span class="line">    <span class="comment">// 检查分数值是否为非数字，如果是则终止程序。</span></span><br><span class="line">    serverAssert(!isnan(score));</span><br><span class="line">    <span class="comment">// 将临时节点指针指向跳跃列表的头部。</span></span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="comment">// 从上到下遍历跳跃列表的每一层。</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* store rank that is crossed to reach the insert position */</span></span><br><span class="line">        <span class="comment">// 初始化各层插入位置之前的节点数量为0。</span></span><br><span class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</span><br><span class="line">        <span class="comment">// 如果当前层有后继节点且后继节点的分数值小于插入节点的分数值</span></span><br><span class="line">        <span class="comment">// 或者分数值相同但后继节点的元素值小于插入节点的元素值，则向右遍历。</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score &lt; score ||</span><br><span class="line">                    (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</span><br><span class="line">                    sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 累加各层插入位置之前的节点数量。</span></span><br><span class="line">            rank[i] += x-&gt;level[i].span;</span><br><span class="line">            <span class="comment">// 将临时节点指针指向其后继节点。</span></span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将需要更新的节点的指针存入数组。</span></span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* we assume the element is not already inside, since we allow duplicated</span></span><br><span class="line"><span class="comment">     * scores, reinserting the same element should never happen since the</span></span><br><span class="line"><span class="comment">     * caller of zslInsert() should test in the hash table if the element is</span></span><br><span class="line"><span class="comment">     * already inside or not. */</span></span><br><span class="line">    <span class="comment">// 生成一个随机的层数。</span></span><br><span class="line">    level = zslRandomLevel();</span><br><span class="line">    <span class="comment">// 如果随机生成的层数大于跳跃列表的当前层数，则进行相应的更新。</span></span><br><span class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</span><br><span class="line">        <span class="comment">// 将新增加的层的插入位置之前的节点数量和需要更新的节点的指针进行初始化。</span></span><br><span class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</span><br><span class="line">            rank[i] = <span class="number">0</span>;</span><br><span class="line">            update[i] = zsl-&gt;header;</span><br><span class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新跳跃列表的层数。</span></span><br><span class="line">        zsl-&gt;level = level;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建一个新的节点。</span></span><br><span class="line">    x = zslCreateNode(level,score,ele);</span><br><span class="line">    <span class="comment">// 将新节点插入到跳跃列表中，并更新相应的指针和跨度。</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</span><br><span class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</span><br><span class="line">        update[i]-&gt;level[i].forward = x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></span><br><span class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</span><br><span class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新未改动的层的跨度。</span></span><br><span class="line">    <span class="comment">/* increment span for untouched levels */</span></span><br><span class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        update[i]-&gt;level[i].span++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置新节点的后向指针。</span></span><br><span class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 如果新节点有后继节点，则设置后继节点的后向指针，否则更新跳跃列表的尾部。</span></span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        zsl-&gt;tail = x;</span><br><span class="line">    <span class="comment">// 更新跳跃列表的长度。</span></span><br><span class="line">    zsl-&gt;length++;</span><br><span class="line">    <span class="comment">// 返回新的插入节点</span></span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetTypeMaybeConvert -&gt; zsetConvertAndExpand -&gt; zzlInsertAt:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在有序列表中插入一个元素和对应的分数值。</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">zzlInsertAt</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr, sds ele, <span class="keyword">double</span> score)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化一个用于保存插入位置的指针。</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *sptr;</span><br><span class="line">    <span class="comment">// 初始化一个用于保存分数值字符串的缓冲区。</span></span><br><span class="line">    <span class="keyword">char</span> scorebuf[MAX_D2STRING_CHARS];</span><br><span class="line">    <span class="comment">// 初始化一个用于保存分数值字符串长度的变量。</span></span><br><span class="line">    <span class="keyword">int</span> scorelen = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 初始化一个用于保存转换后的长整型分数值的变量。</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> lscore;</span><br><span class="line">    <span class="comment">// 尝试将分数值转换为长整型，如果成功则返回1，否则返回0。</span></span><br><span class="line">    <span class="keyword">int</span> score_is_long = double2ll(score, &amp;lscore);</span><br><span class="line">    <span class="keyword">if</span> (!score_is_long)</span><br><span class="line">        <span class="comment">// 如果分数值不能转换为长整型，则将分数值转换为字符串，并保存其长度。</span></span><br><span class="line">        scorelen = d2string(scorebuf,<span class="keyword">sizeof</span>(scorebuf),score);</span><br><span class="line">    <span class="comment">// 如果插入位置为空，则将元素和分数值追加到有序列表的末尾。</span></span><br><span class="line">    <span class="keyword">if</span> (eptr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        zl = lpAppend(zl,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)ele,sdslen(ele));</span><br><span class="line">        <span class="comment">// 如果分数值是长整型，则追加一个整型分数值，否则追加一个字符串分数值。</span></span><br><span class="line">        <span class="keyword">if</span> (score_is_long)</span><br><span class="line">            zl = lpAppendInteger(zl,lscore);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            zl = lpAppend(zl,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)scorebuf,scorelen);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 在指定元素之前插入新元素，并保存插入位置。</span></span><br><span class="line">        <span class="comment">/* Insert member before the element &#x27;eptr&#x27;. */</span></span><br><span class="line">        zl = lpInsertString(zl,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)ele,sdslen(ele),eptr,LP_BEFORE,&amp;sptr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Insert score after the member. */</span></span><br><span class="line">        <span class="comment">// 在新插入的元素之后插入分数值。</span></span><br><span class="line">        <span class="comment">// 如果分数值是长整型，则插入一个整型分数值，否则插入一个字符串分数值。</span></span><br><span class="line">        <span class="keyword">if</span> (score_is_long)</span><br><span class="line">            zl = lpInsertInteger(zl,lscore,sptr,LP_AFTER,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            zl = lpInsertString(zl,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)scorebuf,scorelen,sptr,LP_AFTER,<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回修改后的有序列表。</span></span><br><span class="line">    <span class="keyword">return</span> zl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetAdd:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Add a new element or update the score of an existing element in a sorted</span></span><br><span class="line"><span class="comment"> * set, regardless of its encoding.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The set of flags change the command behavior. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The input flags are the following:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ZADD_INCR: Increment the current element score by &#x27;score&#x27; instead of updating</span></span><br><span class="line"><span class="comment"> *            the current element score. If the element does not exist, we</span></span><br><span class="line"><span class="comment"> *            assume 0 as previous score.</span></span><br><span class="line"><span class="comment"> * ZADD_NX:   Perform the operation only if the element does not exist.</span></span><br><span class="line"><span class="comment"> * ZADD_XX:   Perform the operation only if the element already exist.</span></span><br><span class="line"><span class="comment"> * ZADD_GT:   Perform the operation on existing elements only if the new score is </span></span><br><span class="line"><span class="comment"> *            greater than the current score.</span></span><br><span class="line"><span class="comment"> * ZADD_LT:   Perform the operation on existing elements only if the new score is </span></span><br><span class="line"><span class="comment"> *            less than the current score.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When ZADD_INCR is used, the new score of the element is stored in</span></span><br><span class="line"><span class="comment"> * &#x27;*newscore&#x27; if &#x27;newscore&#x27; is not NULL.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The returned flags are the following:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ZADD_NAN:     The resulting score is not a number.</span></span><br><span class="line"><span class="comment"> * ZADD_ADDED:   The element was added (not present before the call).</span></span><br><span class="line"><span class="comment"> * ZADD_UPDATED: The element score was updated.</span></span><br><span class="line"><span class="comment"> * ZADD_NOP:     No operation was performed because of NX or XX.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return value:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns 1 on success, and sets the appropriate flags</span></span><br><span class="line"><span class="comment"> * ADDED or UPDATED to signal what happened during the operation (note that</span></span><br><span class="line"><span class="comment"> * none could be set if we re-added an element using the same score it used</span></span><br><span class="line"><span class="comment"> * to have, or in the case a zero increment is used).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns 0 on error, currently only when the increment</span></span><br><span class="line"><span class="comment"> * produces a NAN condition, or when the &#x27;score&#x27; value is NAN since the</span></span><br><span class="line"><span class="comment"> * start.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The command as a side effect of adding a new element may convert the sorted</span></span><br><span class="line"><span class="comment"> * set internal encoding from listpack to hashtable+skiplist.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Memory management of &#x27;ele&#x27;:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function does not take ownership of the &#x27;ele&#x27; SDS string, but copies</span></span><br><span class="line"><span class="comment"> * it if needed. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">zsetAdd</span><span class="params">(robj *zobj, <span class="keyword">double</span> score, sds ele, <span class="keyword">int</span> in_flags, <span class="keyword">int</span> *out_flags, <span class="keyword">double</span> *newscore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* Turn options into simple to check vars. */</span></span><br><span class="line">    <span class="comment">// 将选项转化成更易于判断的变量</span></span><br><span class="line">    <span class="keyword">int</span> incr = (in_flags &amp; ZADD_IN_INCR) != <span class="number">0</span>; <span class="comment">// 判断是否需要增加分数</span></span><br><span class="line">    <span class="keyword">int</span> nx = (in_flags &amp; ZADD_IN_NX) != <span class="number">0</span>; <span class="comment">// 判断是否需要在元素不存在时才添加</span></span><br><span class="line">    <span class="keyword">int</span> xx = (in_flags &amp; ZADD_IN_XX) != <span class="number">0</span>; <span class="comment">// 判断是否需要在元素已存在时才更新</span></span><br><span class="line">    <span class="keyword">int</span> gt = (in_flags &amp; ZADD_IN_GT) != <span class="number">0</span>; <span class="comment">// 判断是否只有当新分数大于旧分数时才更新</span></span><br><span class="line">    <span class="keyword">int</span> lt = (in_flags &amp; ZADD_IN_LT) != <span class="number">0</span>; <span class="comment">// 判断是否只有当新分数小于旧分数时才更新</span></span><br><span class="line">    *out_flags = <span class="number">0</span>; <span class="comment">/* We&#x27;ll return our response flags. */</span>   <span class="comment">// 初始化返回的标记为0</span></span><br><span class="line">    <span class="keyword">double</span> curscore; <span class="comment">// 用于存储当前元素的分数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* NaN as input is an error regardless of all the other parameters. */</span></span><br><span class="line">    <span class="comment">// 如果输入的分数是NaN，则返回错误</span></span><br><span class="line">    <span class="keyword">if</span> (isnan(score)) &#123;</span><br><span class="line">        *out_flags = ZADD_OUT_NAN;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update the sorted set according to its encoding. */</span></span><br><span class="line">    <span class="comment">// 如果编码类型为LISTPACK</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_LISTPACK) &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查找元素，如果找到则返回元素的位置和分数</span></span><br><span class="line">        <span class="keyword">if</span> ((eptr = zzlFind(zobj-&gt;ptr,ele,&amp;curscore)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* NX? Return, same element already exists. */</span></span><br><span class="line">            <span class="comment">// 如果不存在才插入</span></span><br><span class="line">            <span class="keyword">if</span> (nx) &#123;</span><br><span class="line">               <span class="comment">// 为标识新增ZADD_OUT_NOP</span></span><br><span class="line">                *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">                <span class="comment">// 返回1</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Prepare the score for the increment if needed. */</span></span><br><span class="line">            <span class="comment">// 如果有incr选项</span></span><br><span class="line">            <span class="keyword">if</span> (incr) &#123;</span><br><span class="line">                <span class="comment">// 则将分数加上原来的分数</span></span><br><span class="line">                score += curscore;</span><br><span class="line">                <span class="keyword">if</span> (isnan(score)) &#123;</span><br><span class="line">                    *out_flags |= ZADD_OUT_NAN;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* GT/LT? Only update if score is greater/less than current. */</span></span><br><span class="line">            <span class="comment">// 校验LT和GT是否符合条件</span></span><br><span class="line">            <span class="keyword">if</span> ((lt &amp;&amp; score &gt;= curscore) || (gt &amp;&amp; score &lt;= curscore)) &#123;</span><br><span class="line">                *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果有传newscore，则将newscore设置为score</span></span><br><span class="line">            <span class="keyword">if</span> (newscore) *newscore = score;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Remove and re-insert when score changed. */</span></span><br><span class="line">            <span class="comment">// 如果新的分数不等于当前分数</span></span><br><span class="line">            <span class="keyword">if</span> (score != curscore) &#123;</span><br><span class="line">                <span class="comment">// 将原来的元素进行删除</span></span><br><span class="line">                zobj-&gt;ptr = zzlDelete(zobj-&gt;ptr,eptr);</span><br><span class="line">                <span class="comment">// 新增新的元素到zset中</span></span><br><span class="line">                zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</span><br><span class="line">                *out_flags |= ZADD_OUT_UPDATED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!xx) &#123;</span><br><span class="line">            <span class="comment">// 如果元素不在列表中，且未设置XX参数，则插入元素</span></span><br><span class="line">            <span class="comment">/* check if the element is too large or the list</span></span><br><span class="line"><span class="comment">             * becomes too long *before* executing zzlInsert. */</span></span><br><span class="line">            <span class="comment">// listpack超过服务器的限制则进行类型转化转化成skiplist</span></span><br><span class="line">            <span class="keyword">if</span> (zzlLength(zobj-&gt;ptr)+<span class="number">1</span> &gt; server.zset_max_listpack_entries ||</span><br><span class="line">                sdslen(ele) &gt; server.zset_max_listpack_value ||</span><br><span class="line">                !lpSafeToAdd(zobj-&gt;ptr, sdslen(ele)))</span><br><span class="line">            &#123;</span><br><span class="line">                zsetConvertAndExpand(zobj, OBJ_ENCODING_SKIPLIST, zsetLength(zobj) + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 将元素插入zobj中</span></span><br><span class="line">                zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</span><br><span class="line">                <span class="comment">// 如果有传newscore，则将newscore设置为score</span></span><br><span class="line">                <span class="keyword">if</span> (newscore) *newscore = score;</span><br><span class="line">                *out_flags |= ZADD_OUT_ADDED;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note that the above block handling listpack would have either returned or</span></span><br><span class="line"><span class="comment">     * converted the key to skiplist. */</span></span><br><span class="line">    <span class="comment">// 如果有序集合的编码方式为跳跃列表</span></span><br><span class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123;</span><br><span class="line">        <span class="comment">// 获取zset对象</span></span><br><span class="line">        zset *zs = zobj-&gt;ptr;</span><br><span class="line">        zskiplistNode *znode;</span><br><span class="line">        dictEntry *de;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在字典中查找元素</span></span><br><span class="line">        de = dictFind(zs-&gt;dict,ele);</span><br><span class="line">        <span class="comment">// 如果存在于字典中</span></span><br><span class="line">        <span class="keyword">if</span> (de != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">/* NX? Return, same element already exists. */</span></span><br><span class="line">            <span class="comment">// 检查命令是否包含NX选项，不存在才变更</span></span><br><span class="line">            <span class="keyword">if</span> (nx) &#123;</span><br><span class="line">                <span class="comment">// 如果包含设置ZADD_OUT_NOP标识，没事没有任何处理</span></span><br><span class="line">                *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">                <span class="comment">// 返回1</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取当前元素在zset中的分数</span></span><br><span class="line">            curscore = *(<span class="keyword">double</span>*)dictGetVal(de);</span><br><span class="line">            <span class="comment">// 如果命令包含incr</span></span><br><span class="line">            <span class="comment">/* Prepare the score for the increment if needed. */</span></span><br><span class="line">            <span class="keyword">if</span> (incr) &#123;</span><br><span class="line">                <span class="comment">// 将增加的分数加上当前的分数得到最终的分数</span></span><br><span class="line">                score += curscore;</span><br><span class="line">                <span class="comment">// 判断score是否为数值  &quot;Not a Number&quot;（NaN）</span></span><br><span class="line">                <span class="keyword">if</span> (isnan(score)) &#123;</span><br><span class="line">                    *out_flags |= ZADD_OUT_NAN;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果设置了GT或LT参数，且新分数不满足条件，则返回</span></span><br><span class="line">            <span class="comment">/* GT/LT? Only update if score is greater/less than current. */</span></span><br><span class="line">            <span class="keyword">if</span> ((lt &amp;&amp; score &gt;= curscore) || (gt &amp;&amp; score &lt;= curscore)) &#123;</span><br><span class="line">                *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newscore) *newscore = score;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Remove and re-insert when score changes. */</span></span><br><span class="line">            <span class="comment">// 如果新分数和旧分数不同，则更新分数</span></span><br><span class="line">            <span class="keyword">if</span> (score != curscore) &#123;</span><br><span class="line">                znode = zslUpdateScore(zs-&gt;zsl,curscore,ele,score);</span><br><span class="line">                <span class="comment">/* Note that we did not removed the original element from</span></span><br><span class="line"><span class="comment">                 * the hash table representing the sorted set, so we just</span></span><br><span class="line"><span class="comment">                 * update the score. */</span></span><br><span class="line">                dictSetVal(zs-&gt;dict, de, &amp;znode-&gt;score); <span class="comment">/* Update score ptr. */</span></span><br><span class="line">                *out_flags |= ZADD_OUT_UPDATED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!xx) &#123;</span><br><span class="line">            <span class="comment">// 如果元素不在字典中，且未设置XX参数，则插入元素</span></span><br><span class="line">            ele = sdsdup(ele);</span><br><span class="line">            <span class="comment">// 将元素加入跳表中</span></span><br><span class="line">            znode = zslInsert(zs-&gt;zsl,score,ele);</span><br><span class="line">            <span class="comment">// 将数值加入字典中</span></span><br><span class="line">            serverAssert(dictAdd(zs-&gt;dict,ele,&amp;znode-&gt;score) == DICT_OK);</span><br><span class="line">            *out_flags |= ZADD_OUT_ADDED;</span><br><span class="line">            <span class="comment">// 更新新的分值</span></span><br><span class="line">            <span class="keyword">if</span> (newscore) *newscore = score;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            *out_flags |= ZADD_OUT_NOP;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverPanic(<span class="string">&quot;Unknown sorted set encoding&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* Never reached. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetAdd -&gt; zzlDelete -&gt; lpDeleteRangeWithEntry:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Delete (element,score) pair from listpack. Use local copy of eptr because we</span></span><br><span class="line"><span class="comment"> * don&#x27;t want to modify the one given as argument. */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">zzlDelete</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用lpDeleteRangeWithEntry函数删除元素，传入的参数是2，表示删除元素及其分数</span></span><br><span class="line">    <span class="keyword">return</span> lpDeleteRangeWithEntry(zl,&amp;eptr,<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Delete a range of entries from the listpack start with the element pointed by &#x27;p&#x27;. */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">lpDeleteRangeWithEntry</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *lp, <span class="keyword">unsigned</span> <span class="keyword">char</span> **p, <span class="keyword">unsigned</span> <span class="keyword">long</span> num)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 计算listpack的总字节数</span></span><br><span class="line">    <span class="keyword">size_t</span> bytes = lpBytes(lp);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> deleted = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 计算listpack结尾的指针</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *eofptr = lp + bytes - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *first, *tail;</span><br><span class="line">    first = tail = *p;</span><br><span class="line">    <span class="comment">// 如果需要删除的元素数为0，则直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">0</span>) <span class="keyword">return</span> lp;  <span class="comment">/* Nothing to delete, return ASAP. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find the next entry to the last entry that needs to be deleted.</span></span><br><span class="line"><span class="comment">     * lpLength may be unreliable due to corrupt data, so we cannot</span></span><br><span class="line"><span class="comment">     * treat &#x27;num&#x27; as the number of elements to be deleted. */</span></span><br><span class="line">    <span class="comment">// 查找需要删除的最后一个元素的下一个元素</span></span><br><span class="line">    <span class="keyword">while</span> (num--) &#123;</span><br><span class="line">        deleted++;</span><br><span class="line">        <span class="comment">// 跳过当前元素，移动到下一个元素</span></span><br><span class="line">        tail = lpSkip(tail);</span><br><span class="line">        <span class="comment">// 如果已经到达listpack的结尾，就跳出循环</span></span><br><span class="line">        <span class="keyword">if</span> (tail[<span class="number">0</span>] == LP_EOF) <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// 检查当前元素是否有效</span></span><br><span class="line">        lpAssertValidEntry(lp, bytes, tail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Store the offset of the element &#x27;first&#x27;, so that we can obtain its</span></span><br><span class="line"><span class="comment">     * address again after a reallocation. */</span></span><br><span class="line">    <span class="comment">// 存储第一个需要删除的元素的偏移量，因为在重新分配内存后，我们需要通过这个偏移量来找到它的地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> poff = first-lp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Move tail to the front of the listpack */</span></span><br><span class="line">    <span class="comment">// 将tail及其后面的元素向前移动，覆盖掉需要删除的元素</span></span><br><span class="line">    memmove(first, tail, eofptr - tail + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 更新listpack的总字节数</span></span><br><span class="line">    lpSetTotalBytes(lp, bytes - (tail - first));</span><br><span class="line">    <span class="comment">// 获取listpack的元素数量</span></span><br><span class="line">    <span class="keyword">uint32_t</span> numele = lpGetNumElements(lp);</span><br><span class="line">    <span class="comment">// 如果元素数量不为未知，那么更新元素数量</span></span><br><span class="line">    <span class="keyword">if</span> (numele != LP_HDR_NUMELE_UNKNOWN)</span><br><span class="line">        lpSetNumElements(lp, numele-deleted);</span><br><span class="line">    <span class="comment">// 重新分配内存，使其大小刚好适应当前的元素</span></span><br><span class="line">    lp = lpShrinkToFit(lp);</span><br><span class="line">    <span class="comment">/* Store the entry. */</span></span><br><span class="line">    <span class="comment">// 存储第一个被删除的元素的新地址</span></span><br><span class="line">    *p = lp+poff;</span><br><span class="line">    <span class="comment">// 如果该地址是listpack的结尾，那么将其设置为NULL</span></span><br><span class="line">    <span class="keyword">if</span> ((*p)[<span class="number">0</span>] == LP_EOF) *p = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 返回新的listpack的地址</span></span><br><span class="line">    <span class="keyword">return</span> lp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetAdd -&gt; zzlInsert:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Insert (element,score) pair in listpack. This function assumes the element is</span></span><br><span class="line"><span class="comment"> * not yet present in the list. */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">zzlInsert</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, sds ele, <span class="keyword">double</span> score)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// eptr指向listpack的第一个元素</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr = lpSeek(zl,<span class="number">0</span>), *sptr;</span><br><span class="line">    <span class="keyword">double</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历listpack中的每个元素</span></span><br><span class="line">    <span class="keyword">while</span> (eptr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// sptr指向元素的分数</span></span><br><span class="line">        sptr = lpNext(zl,eptr);</span><br><span class="line">        <span class="comment">// 断言sptr不为NULL</span></span><br><span class="line">        serverAssert(sptr != <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// 获取当前元素的分数</span></span><br><span class="line">        s = zzlGetScore(sptr);</span><br><span class="line">        <span class="comment">// 如果当前元素的分数大于待插入元素的分数</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt; score) &#123;</span><br><span class="line">            <span class="comment">/* First element with score larger than score for element to be</span></span><br><span class="line"><span class="comment">             * inserted. This means we should take its spot in the list to</span></span><br><span class="line"><span class="comment">             * maintain ordering. */</span></span><br><span class="line">            <span class="comment">// 在当前元素的位置插入新元素，以保持排序的有序性</span></span><br><span class="line">            zl = zzlInsertAt(zl,eptr,ele,score);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s == score) &#123;</span><br><span class="line">            <span class="comment">/* Ensure lexicographical ordering for elements. */</span></span><br><span class="line">            <span class="comment">// 如果当前元素的分数等于待插入元素的分数</span></span><br><span class="line">            <span class="comment">// 如果当前元素在字典序上大于待插入元素，则在当前元素的位置插入新元素</span></span><br><span class="line">            <span class="keyword">if</span> (zzlCompareElements(eptr,(<span class="keyword">unsigned</span> <span class="keyword">char</span>*)ele,sdslen(ele)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                zl = zzlInsertAt(zl,eptr,ele,score);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Move to next element. */</span></span><br><span class="line">        <span class="comment">// 移动到下一个元素</span></span><br><span class="line">        eptr = lpNext(zl,sptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Push on tail of list when it was not yet inserted. */</span></span><br><span class="line">    <span class="comment">// 如果待插入元素还未被插入，则将其插入到listpack的尾部</span></span><br><span class="line">    <span class="keyword">if</span> (eptr == <span class="literal">NULL</span>)</span><br><span class="line">        zl = zzlInsertAt(zl,<span class="literal">NULL</span>,ele,score);</span><br><span class="line">    <span class="keyword">return</span> zl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetAdd -&gt; zslUpdateScore:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Update the score of an element inside the sorted set skiplist.</span></span><br><span class="line"><span class="comment"> * Note that the element must exist and must match &#x27;score&#x27;.</span></span><br><span class="line"><span class="comment"> * This function does not update the score in the hash table side, the</span></span><br><span class="line"><span class="comment"> * caller should take care of it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that this function attempts to just update the node, in case after</span></span><br><span class="line"><span class="comment"> * the score update, the node would be exactly at the same position.</span></span><br><span class="line"><span class="comment"> * Otherwise the skiplist is modified by removing and re-adding a new</span></span><br><span class="line"><span class="comment"> * element, which is more costly.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns the updated element skiplist node pointer. */</span></span><br><span class="line"><span class="function">zskiplistNode *<span class="title">zslUpdateScore</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> curscore, sds ele, <span class="keyword">double</span> newscore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定义一个update数组，用于保存每一层的前驱节点</span></span><br><span class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to seek to element to update to start: this is useful anyway,</span></span><br><span class="line"><span class="comment">     * we&#x27;ll have to update or remove it. */</span></span><br><span class="line">    <span class="comment">// 从跳跃列表的头节点开始查找要更新的元素</span></span><br><span class="line">    x = zsl-&gt;header;</span><br><span class="line">    <span class="comment">// 从最高层开始查找</span></span><br><span class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">// 在当前层进行查找，直到找到的节点的下一个节点的分数大于等于要查找的分数</span></span><br><span class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</span><br><span class="line">                (x-&gt;level[i].forward-&gt;score &lt; curscore ||</span><br><span class="line">                    (x-&gt;level[i].forward-&gt;score == curscore &amp;&amp;</span><br><span class="line">                     sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; <span class="number">0</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 向前移动</span></span><br><span class="line">            x = x-&gt;level[i].forward;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存当前层的前驱节点</span></span><br><span class="line">        update[i] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Jump to our element: note that this function assumes that the</span></span><br><span class="line"><span class="comment">     * element with the matching score exists. */</span></span><br><span class="line">    <span class="comment">// 跳到要更新的元素</span></span><br><span class="line">    x = x-&gt;level[<span class="number">0</span>].forward;</span><br><span class="line">    <span class="comment">// 断言要更新的元素确实存在</span></span><br><span class="line">    serverAssert(x &amp;&amp; curscore == x-&gt;score &amp;&amp; sdscmp(x-&gt;ele,ele) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the node, after the score update, would be still exactly</span></span><br><span class="line"><span class="comment">     * at the same position, we can just update the score without</span></span><br><span class="line"><span class="comment">     * actually removing and re-inserting the element in the skiplist. */</span></span><br><span class="line">    <span class="comment">// 如果更新分数后，元素的位置不变，则直接更新元素的分数</span></span><br><span class="line">    <span class="keyword">if</span> ((x-&gt;backward == <span class="literal">NULL</span> || x-&gt;backward-&gt;score &lt; newscore) &amp;&amp;</span><br><span class="line">        (x-&gt;level[<span class="number">0</span>].forward == <span class="literal">NULL</span> || x-&gt;level[<span class="number">0</span>].forward-&gt;score &gt; newscore))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 更新元素的分数</span></span><br><span class="line">        x-&gt;score = newscore;</span><br><span class="line">        <span class="comment">// 返回更新后的元素</span></span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* No way to reuse the old node: we need to remove and insert a new</span></span><br><span class="line"><span class="comment">     * one at a different place. */</span></span><br><span class="line">    <span class="comment">// 如果更新分数后，元素的位置会改变，我们需要删除旧节点，然后在新的位置插入新节点</span></span><br><span class="line">    zslDeleteNode(zsl, x, update);</span><br><span class="line">    <span class="comment">// 插入新节点</span></span><br><span class="line">    zskiplistNode *newnode = zslInsert(zsl,newscore,x-&gt;ele);</span><br><span class="line">    <span class="comment">/* We reused the old node x-&gt;ele SDS string, free the node now</span></span><br><span class="line"><span class="comment">     * since zslInsert created a new one. */</span></span><br><span class="line">    <span class="comment">// 释放旧节点</span></span><br><span class="line">    x-&gt;ele = <span class="literal">NULL</span>;释放旧节点</span><br><span class="line">    zslFreeNode(x);</span><br><span class="line">    <span class="comment">// 返回新节点</span></span><br><span class="line">    <span class="keyword">return</span> newnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>-&gt; zaddCommand -&gt; zaddGenericCommand -&gt; zsetAdd -&gt; zslUpdateScore -&gt; zslDeleteNode:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Internal function used by zslDelete, zslDeleteRangeByScore and</span></span><br><span class="line"><span class="comment"> * zslDeleteRangeByRank. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zslDeleteNode</span><span class="params">(zskiplist *zsl, zskiplistNode *x, zskiplistNode **update)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">// 遍历所有层级</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; zsl-&gt;level; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (update[i]-&gt;level[i].forward == x) &#123;</span><br><span class="line">            <span class="comment">// 如果在第i层的下一个节点是需要删除的节点，那么修改元素数量（跨度）并让update[i]跳过x节点</span></span><br><span class="line">            update[i]-&gt;level[i].span += x-&gt;level[i].span - <span class="number">1</span>;</span><br><span class="line">            update[i]-&gt;level[i].forward = x-&gt;level[i].forward;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果在第i层的下一个节点不是需要删除的节点，那么只需要减少跨度中的元素数量</span></span><br><span class="line">            update[i]-&gt;level[i].span -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新x的下一个节点的backward指针，如果x没有下一个节点，那么将x的前一个节点设为zsl的尾节点</span></span><br><span class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward) &#123;</span><br><span class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x-&gt;backward;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        zsl-&gt;tail = x-&gt;backward;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果zsl-&gt;level对应的层级没有节点，那么降低跳跃列表的层级</span></span><br><span class="line">    <span class="keyword">while</span>(zsl-&gt;level &gt; <span class="number">1</span> &amp;&amp; zsl-&gt;header-&gt;level[zsl-&gt;level<span class="number">-1</span>].forward == <span class="literal">NULL</span>)</span><br><span class="line">        zsl-&gt;level--;</span><br><span class="line">    <span class="comment">// 跳跃列表的长度减1</span></span><br><span class="line">    zsl-&gt;length--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>nytech
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://nytech3.github.io/2023/09/24/redis/redis_zadd/" title="源码阅读(七)-Redis中的ZADD命令">https://nytech3.github.io/2023/09/24/redis/redis_zadd/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/c/" rel="tag"># c</a>
              <a href="/tags/redis/" rel="tag"># redis</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/09/23/redis/redis_sadd/" rel="prev" title="源码阅读(六)-Redis中的SADD命令">
      <i class="fa fa-chevron-left"></i> 源码阅读(六)-Redis中的SADD命令
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/09/26/redis/redis_pipeline/" rel="next" title="源码阅读(八)-Redis中的MULTI命令(PIPELINE)">
      源码阅读(八)-Redis中的MULTI命令(PIPELINE) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">工作流程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-number">2.</span> <span class="nav-text">源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ZADD-json"><span class="nav-number">2.1.</span> <span class="nav-text">ZADD json</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%A0%B7%E4%BE%8B"><span class="nav-number">2.2.</span> <span class="nav-text">命令执行样例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">2.3.</span> <span class="nav-text">代码分析</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="nytech"
      src="/images/author.jpg">
  <p class="site-author-name" itemprop="name">nytech</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nytech3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nytech3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nytech</span>
</div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"J6lBEIRqy1W5i6vcNgfWkL1P-gzGzoHsz","app_key":"tlzt00UvOikqxddgeJ59o1id","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  
  <script color='0,0,0' opacity='0.5' zIndex='-1' count='150' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
